#!/bin/sh
# PCP QA Test No. 998
# Exercise libpcp: unlock context before returning
# See https://github.com/performancecopilot/pcp/pull/50
#
# Copyright (c) 2015 Ken McDonell.  All Rights Reserved.
#

seq=`basename $0`
echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

status=1	# failure is the default!
trap "cd $here; $sudo rm -rf $tmp.*; exit \$status" 0 1 2 3 15

# need hostname before we dink with LD_PRELOAD
#
hostname=`hostname`

# libpcp_fault WILL have lock_asserts=true, if it is installed
#
if [ -f $PCP_LIB_DIR/libpcp_fault.so.4 ]
then
    preload=$PCP_LIB_DIR/libpcp_fault.so.4
else
    preload=''
fi

eval `LD_PRELOAD=$preload $PCP_BINADM_DIR/pmconfig -L lock_asserts`
echo "lock_asserts=$lock_asserts" >>$seq_full

# The alternate filter is required if libpcp is built with
# BUILD_LOCK_ASSERTS defined.
#
# Otherwise expect this ...
# Unlock Fail: Operation not permitted
# may see this on Solaris/OpenIndiana ...
# Unlock Fail: Not owner
#
_filter()
{
    if $lock_asserts
    then
	# don't get the Unlock Fail: message in this case, so
	# sythesize it from the __pmUnlock() diagnostic
	#
	tee -a $seq_full \
	| sed \
	    -e '/^github-50.c:.*pmUnlock(/s/.*/Unlock Fail: Operation not permitted/' \
	    -e '/^Aborted (core dumped)/d' \
	    -e '/^Aborted$/d' \
	    -e '/^Abort trap (core dumped)/d' \
	| $PCP_AWK_PROG '
$1 == "backtrace:"	{ exit }
$3 == "traceback"	{ exit }
			{ print }'
    else
	tee -a $seq_full \
	| sed \
	    -e '/^github-50.c:.*pmUnlock(.* not permitted/d' \
	    -e '/^github-50.c:.*pmUnlock(.* Not owner/d' \
	    -e 's/Not owner/Operation not permitted/' \
	# end
    fi
}

# real QA test starts here
echo "=== -x (no context) ===" | tee -a $seq_full
( LD_PRELOAD=$preload src/github-50 2>&1 -x && exit 0 ) 2>&1 | _filter

echo | tee -a $seq_full
echo "=== no args, default context ===" | tee -a $seq_full
( LD_PRELOAD=$preload src/github-50 2>&1 && exit 0 ) 2>&1 | _filter

echo | tee -a $seq_full
echo "=== -h local: ===" | tee -a $seq_full
( LD_PRELOAD=$preload src/github-50 2>&1 -h 'local:' && exit 0 ) 2>&1 | _filter

echo | tee -a $seq_full
echo "=== -h hostname ===" | tee -a $seq_full
( LD_PRELOAD=$preload src/github-50 2>&1 -h $hostname && exit 0 ) 2>&1 | _filter

# strangely on OpenBSD (vm37) this reports the error but does not
# dump core, leading two "Unlock Fail: Operation not permitted" lines,
# hence the fluffin' about at the end
#
echo | tee -a $seq_full
echo '=== -L ===' | tee -a $seq_full
( $sudo_local_ctx sh -c "LD_PRELOAD=$preload src/github-50 2>&1 -L" && exit 0 ) 2>&1 | _filter >$tmp.tmp
grep -v 'Unlock Fail' <$tmp.tmp
grep 'Unlock Fail' $tmp.tmp | sort | uniq

echo | tee -a $seq_full
echo '=== -a archives/ok-foo ===' | tee -a $seq_full
( LD_PRELOAD=$preload src/github-50 2>&1 -a archives/ok-foo && exit 0 ) 2>&1 | _filter

# this calls abort() on the error paths, so we may have core files ...
# this is not cause for failing the test
#
rm -f core

# success, all done
status=0

exit
