#!/bin/sh
#
# Make exports from exports.in
#
# Do conditionals first, then strip comments
#

if [ -n "$PCP_TMPFILE_DIR" -a -d "$PCP_TMPFILE_DIR" ]
then
    tmp=`mktemp -d "$PCP_TMPFILE_DIR/pcp-build-mk.exports.XXXXXXXXX"` || exit 1
else
    # assume run during a build and /tmp is a safe bet
    #
    tmp=`mktemp -d "/tmp/pcp-build-mk.exports.XXXXXXXXX"` || exit 1
fi

sts=0
trap "rm -rf $tmp; exit \$sts" 0 1 2 3 15
rm -f $tmp.err exports

# debug=true => dump generated awk script on stderr for debugging
debug=false

if [ ! -f ../../include/pcp.conf ]
then
    echo "mk.exports: Botch: ../../include/pcp.conf missing: configure not run yet?"
    sts=1
    exit
fi
. ../../include/pcp.conf

def_files="../../include/builddefs ../../include/pcp/platform_defs.h ../../include/pcp/config.h"

for file in $def_files
do
    if [ ! -f $file  ]
    then
	echo "mk.exports: Botch: $file missing: configure not run yet?"
	sts=1
	exit
    fi
done

echo 'BEGIN {' >$tmp.awk

for file in $def_files
do
    sed -E  -n <$file >>$tmp.awk \
	-e '/^(ENABLE|HAVE)_/{
s/ //g
s/^[^=]*/    defines["&/
s/=/"]="/
s/$/"/
p
}' \
	-e '/^#define HAVE_.* 1$/{
s/[ 	][ 	]*/ /g
s/^#define /defines["/
s/ 1$/"]="true"/
s/^/    /
p
}' \
	-e '/ #undef HAVE_.* /{
s/[ 	][ 	]*/ /g
s/.* #undef /defines["/
s/ .*/"]="false"/
s/^/    /
p
}' \
    # end
done

cat <<End-of-File >>$tmp.awk
}

\$1 == "#if"	{ if (inif) {
		    print "mk.exports: Error: exports.in[" NR "] nested #if" >"$tmp/err"
		    inif = 0
		    exit
		  }
		  inif = NR
		  if (\$2 == "!") {
		    negate = 1
		    check = \$3
		  }
		  else {
		    negate = 0
		    check = \$2
		  }
		  if (check == "$PCP_PLATFORM") {
		    if (negate)
			skip = 1
		    else
			skip = 0
		  }
		  else if (check !~ /^ENABLE_/ && check !~ /^HAVE_/) {
		    skip = 1
		  }
		  else if (defines[check] == "") {
		    print "mk.exports: Error: exports.in[" NR "] " check " not defined in ../../include/*" >"$tmp/err"
		    inif = 0
		    exit
		  }
		  else if (defines[check] != "true" && defines[check] != "false") {
		    print "mk.exports: Error: exports.in[" NR "] " check " unexpected value (" defines[\$2] ") from ../../include/*" >"$tmp/err"
		    inif = 0
		    exit
		  }
		  else if (negate == 0 && defines[check] == "true" || negate == 1 && defines[check] == "false") {
		    skip = 0
		  }
		  else {
		    skip = 1
		  }
		  next
		}
\$1 == "#else"	{ if (!inif) {
		    print "mk.exports: Error: exports.in[" NR "] missing #if" >"$tmp/err"
		    inif = 0
		    exit
		  }
		  skip = 1 - skip
		  next
		}
\$1 == "#endif"	{ if (!inif) {
		    print "mk.exports: Error: exports.in[" NR "] missing #if" >"$tmp/err"
		    inif = 0
		    exit
		  }
		  inif = 0
		  skip = 0
		  next
		}
skip == 1	{ next }
		{ print }
END		{ if (inif) {
		    print "mk.exports: Error: exports.in[" inif "] missing #endif" >"$tmp/err"
		    exit
		  }
		}
End-of-File

cat <<End-of-File >exports
# DO NOT EDIT THIS FILE ... CHANGES HERE WILL BE LOST
#
# This file created from exports.in (make changes there!)
# by mk.exports on ${PACKAGE_BUILD_DATE:-$(date -u -d "@$SOURCE_DATE_EPOCH" 2>/dev/null || date -u -r "$SOURCE_DATE_EPOCH" 2>/dev/null || date)}.
#

End-of-File

$debug && cat >&2 $tmp.awk

$PCP_AWK_PROG -f $tmp.awk <exports.in \
| sed -e '/^#/d' >>exports

if [ -f $tmp/err ]
then
    cat $tmp/err
    rm -f exports
    sts=1
else
    chmod a-w exports
fi

exit
