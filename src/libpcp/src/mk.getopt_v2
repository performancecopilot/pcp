#!/bin/sh
#
# Make the PMAPI_VERSION_2 version of getopt.c for backwards
# compatibility
# - timespec's -> timevals
# - drop HighRes from all function calls
# - rewrite v3 foo(...) to be foo_v2(...)
# - play games wth statics to hide routines that exposed
#   in libpcp.h or internal.h 'cause we don't need them
#

cat <<End-of-File >getopt_v2.c
/*
 * This file was created in the build by mk.getopt_v2 from
 * getopt.c on `date`
 *
 * DO NOT EDIT THIS FILE
 *
 */
End-of-File

awk <getopt.c '
$1 == "#include"	{ state = 1 }
state == 1 && NF == 0	{ state = 2
			  print "#define pmOptions pmOptions_v2"
			}
			{ print }' \
| sed \
    -e 's/struct timespec/struct timeval/g' \
    -e 's/tv_nsec/tv_usec/g' \
    -e 's/pmtimespec\([A-Z]\)/pmtimeval\1/g' \
    -e 's/label\.start/label.ll_start/g' \
    -e 's/HighRes//g' \
    -e 's/pmgetopt_r(/pmgetopt_r_v2(/' \
    -e 's/pmGetContextOptions(/pmGetContextOptions_v2(/' \
    -e 's/pmGetOptions(/pmGetOptions_v2(/' \
    -e 's/pmUsageMessage(/pmUsageMessage_v2(/' \
    -e 's/pmFreeOptions(/pmFreeOptions_v2(/' \
    -e 's/__pmEndOptions(/__pmEndOptions_v2(/' \
    -e 's/__pmStartOptions(/__pmStartOptions_v2(/' \
    -e 's/__pmGetLongOptions(/__pmGetLongOptions_v2(/' \
    -e 's/__pmAddOptArchive(/__pmAddOptArchive_v2(/' \
    -e 's/__pmAddOptArchivePath(/__pmAddOptArchivePath_v2(/' \
    -e 's/__pmAddOptArchiveList(/__pmAddOptArchiveList_v2(/' \
    -e 's/__pmAddOptArchiveFolio(/__pmAddOptArchiveFolio_v2(/' \
    -e 's/__pmAddOptHost(/__pmAddOptHost_v2(/' \
    -e 's/__pmAddOptHostList(/__pmAddOptHostList_v2(/' \
    -e 's/__pmAddOptContainer(/__pmAddOptContainer_v2(/' \
    -e 's/__pmSetLocalContextTable(/__pmSetLocalContextTable_v2(/' \
    -e 's/__pmSetLocalContextFlag(/__pmSetLocalContextFlag_v2(/' \
    -e 's/^void$/static void/' \
    -e 's/opts->version = PMAPI_VERSION/&_2/' \
| sed >>getopt_v2.c \
    -e '/static void/{
N
/static void\npmFreeOptions_v2(/s/static //
/static void\npmUsageMessage_v2(/s/static //
}'
