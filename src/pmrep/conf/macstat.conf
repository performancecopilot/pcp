#
# pmrep(1) configuration file - macOS-specific system statistics
#
# Mimics pmstat(1) output format but adapted for macOS memory model
# and available darwin PMDA metrics
#
# Usage:
#   pmrep :macstat          # basic macOS system statistics
#   pmrep :macstat-x        # extended statistics with compressor activity
#   pmrep :macstat-mem      # memory deep-dive: compression, paging, cache efficiency
#   pmrep :macstat-dsk      # disk deep-dive: IOPS, throughput, latency analysis
#   pmrep :macstat-tcp      # TCP connection monitoring: states, errors, retransmissions
#   pmrep :macstat-proto    # network protocol overview: UDP, ICMP, TCP summary
#   pmrep :macstat-gpu      # GPU utilization and memory monitoring
#   pmrep :macstat-pwr      # battery health, charge status, power source
#   pmrep :macstat-thermal  # CPU/GPU temps, fans, thermal throttling
#

#
# Basic macOS system statistics
# Similar to pmstat but using macOS memory model (wired/active/compressed)
# instead of Linux model (buff/cache), and pageins/pageouts instead of
# swap in/out since macOS memory management differs fundamentally.
#
[macstat]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Load average
kernel.all.load = load avg,1 minute,,,8

# Memory metrics (macOS memory model)
swap.used = swpd,,MB,,6
mem.util.free = free,,MB,,6
mem.util.wired = wired,,MB,,6
mem.util.active = active,,MB,,6
mem.util.compressed = cmpr,,MB,,6

# Paging activity (not swap - macOS pages in/out from compressed memory)
mem.pageins = pi,,,,5
mem.pageouts = po,,,,5

# Disk I/O
disk.all.read = read,,,,6
disk.all.write = write,,,,6

# Network I/O (total across all interfaces)
net_in = network.total.in
net_in.label = netin
net_in.formula = sum(network.interface.in.bytes)
net_in.unit = KB
net_in.width = 7

net_out = network.total.out
net_out.label = netout
net_out.formula = sum(network.interface.out.bytes)
net_out.unit = KB
net_out.width = 7

# CPU utilization percentages
usr = kernel.all.cpu.usrp
usr.label = us
usr.formula = 100 * (kernel.all.cpu.user + kernel.all.cpu.nice) / hinv.ncpu
usr.unit = s
usr.width = 3

sys = kernel.all.cpu.sysp
sys.label = sy
sys.formula = 100 * kernel.all.cpu.sys / hinv.ncpu
sys.unit = s
sys.width = 3

idle = kernel.all.cpu.idlep
idle.label = id
idle.formula = 100 * kernel.all.cpu.idle / hinv.ncpu
idle.unit = s
idle.width = 3

#
# Extended macOS system statistics
# Includes memory compressor activity and process/thread counts
# which are unique to macOS and provide insight into system behavior
#
[macstat-x]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Load average
kernel.all.load = load avg,1 minute,,,8

# Memory metrics (expanded to include inactive)
swap.used = swpd,,MB,,6
mem.util.free = free,,MB,,6
mem.util.wired = wired,,MB,,6
mem.util.active = active,,MB,,6
mem.util.inactive = inact,,MB,,6
mem.util.compressed = cmpr,,MB,,6

# Paging activity
mem.pageins = pi,,,,5
mem.pageouts = po,,,,5

# Memory compressor activity (macOS-specific)
# These show compression/decompression rates - key to understanding
# macOS memory pressure and performance
mem.compressions = comp,,,,5
mem.decompressions = deco,,,,5

# Disk I/O (operations and bandwidth)
disk.all.read = read,,,,6
disk.all.write = write,,,,6
disk.all.read_bytes = rkB/s,,KB,,6
disk.all.write_bytes = wkB/s,,KB,,6

# GPU utilization (quick overview)
gpu.util = gpu%%,,,,4

# Virtual file system resource usage
vfs.files.count = files,,,,6
vfs.files.max = fmax,,,,6
vfs.vnodes.count = vnodes,,,,6

# Process and thread counts
kernel.all.nprocs = proc,,,,5
kernel.all.nthreads = thrd,,,,5

# CPU utilization percentages
usr = kernel.all.cpu.usrp
usr.label = us
usr.formula = 100 * (kernel.all.cpu.user + kernel.all.cpu.nice) / hinv.ncpu
usr.unit = s
usr.width = 3

sys = kernel.all.cpu.sysp
sys.label = sy
sys.formula = 100 * kernel.all.cpu.sys / hinv.ncpu
sys.unit = s
sys.width = 3

idle = kernel.all.cpu.idlep
idle.label = id
idle.formula = 100 * kernel.all.cpu.idle / hinv.ncpu
idle.unit = s
idle.width = 3

#
# Memory deep-dive statistics
# Detailed memory subsystem analysis - diagnose memory pressure and compression efficiency
#
[macstat-mem]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Memory breakdown
mem.physmem = phys,,MB,,7
mem.util.used = used,,MB,,7
mem.util.free = free,,MB,,7
mem.util.wired = wired,,MB,,7
mem.util.active = actv,,MB,,7
mem.util.inactive = inact,,MB,,7
mem.util.compressed = cmpr,,MB,,7

# Swap activity
swap.used = swpd,,MB,,7
swap.free = swfree,,MB,,7
swap.pagesin = si,,,,6
swap.pagesout = so,,,,6

# Compression efficiency (operations and page counts)
mem.compressions = comp,,,,7
mem.decompressions = deco,,,,7
mem.compressor.pages = cpages,,,,7
mem.compressor.uncompressed_pages = upages,,,,7

# Compression timing analysis (swapout latency distribution)
mem.compressor.swapouts_under_30s = <30s,,,,6
mem.compressor.swapouts_under_60s = <60s,,,,6
mem.compressor.swapouts_under_300s = <5m,,,,6
mem.compressor.thrashing_detected = thrash,,,,6

# Paging activity
mem.pageins = pi,,,,6
mem.pageouts = po,,,,6
mem.pages.faults = faults,,,,7
mem.pages.cow_faults = cow,,,,7
mem.pages.zero_filled = zero,,,,7
mem.pages.reactivated = react,,,,7

# NOTE: mem.cache_lookups and mem.cache_hits (from vm_statistics64.lookups/hits)
# are deprecated fields on modern macOS - they always return 0 and are not shown
# by vm_stat. Removed from this view as they provide no useful information.

#
# Disk deep-dive statistics
# Comprehensive disk I/O analysis - latency, throughput, and operation counts
#
[macstat-dsk]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# IOPS (operations per second)
disk.all.read = r/s,,,,6
disk.all.write = w/s,,,,6
disk.all.total = tot/s,,,,6

# Throughput (bandwidth in KB/s)
disk.all.read_bytes = rkB/s,,KB,,7
disk.all.write_bytes = wkB/s,,KB,,7
disk.all.total_bytes = tkB/s,,KB,,7

# Block-level I/O
disk.all.blkread = rblk/s,,,,7
disk.all.blkwrite = wblk/s,,,,7
disk.all.blktotal = tblk/s,,,,7

# Latency (milliseconds)
disk.all.read_time = rms,,,,6
disk.all.write_time = wms,,,,6
disk.all.total_time = tms,,,,6

#
# TCP connection lifecycle and error monitoring
#
[macstat-tcp]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Connection activity
network.tcp.activeopens = actopn,,,,7
network.tcp.passiveopens = psvopn,,,,7
network.tcp.currestab = estab,,,,6

# TCP connection states (all 11 states)
network.tcpconn.established = estab,,,,6
network.tcpconn.syn_sent = synst,,,,6
network.tcpconn.syn_recv = synrv,,,,6
network.tcpconn.fin_wait1 = fin1,,,,5
network.tcpconn.fin_wait2 = fin2,,,,5
network.tcpconn.time_wait = timew,,,,6
network.tcpconn.close = close,,,,6
network.tcpconn.close_wait = closew,,,,7
network.tcpconn.last_ack = lack,,,,5
network.tcpconn.listen = listn,,,,6
network.tcpconn.closing = closg,,,,6

# Error and retransmission metrics
network.tcp.attemptfails = fails,,,,6
network.tcp.estabresets = resets,,,,7
network.tcp.retranssegs = retran,,,,7
network.tcp.inerrs = errs,,,,5
network.tcp.outrsts = rsts,,,,5

# Throughput
network.tcp.insegs = isgmts,,,,7
network.tcp.outsegs = osgmts,,,,7

# Socket usage
network.sockstat.tcp.inuse = tcpsock,,,,7

#
# Network protocol overview statistics
# Protocol-level overview for network troubleshooting
#
[macstat-proto]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto
colxrow = "     IFACE"

# Interface totals (displayed as rows per interface)
network.interface.total.bytes = bytes,,KB,,8
network.interface.total.packets = pkts,,,,8
network.interface.total.errors = errs,,,,6
network.interface.total.drops = drops,,,,6

# UDP statistics
network.udp.indatagrams = udpin,,,,7
network.udp.outdatagrams = udpout,,,,7
network.udp.inerrors = udperr,,,,7
network.udp.noports = udpnop,,,,7
network.udp.rcvbuferrors = udpbuf,,,,7

# ICMP statistics
network.icmp.inmsgs = icmpin,,,,7
network.icmp.outmsgs = icmpout,,,,7
network.icmp.inechos = iecho,,,,6
network.icmp.outechos = oecho,,,,6
network.icmp.inerrors = ierr,,,,5

# TCP summary
network.tcp.insegs = tcpin,,,,6
network.tcp.outsegs = tcpout,,,,7
network.tcp.retranssegs = tcpret,,,,7
network.tcp.inerrs = tcperr,,,,7

# Socket usage (TCP and UDP)
network.sockstat.tcp.inuse = tcpsock,,,,7
network.sockstat.udp.inuse = udpsock,,,,7

#
# GPU monitoring statistics
# Apple Silicon GPU utilization and memory for video editing, ML workloads
#
[macstat-gpu]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# GPU inventory
hinv.ngpu = ngpu,,,,5

# GPU utilization
gpu.util = util%%,,,,6

# GPU memory
gpu.memory.used = used,,MB,,8
gpu.memory.free = free,,MB,,8

# Derived: total VRAM and utilization percentage
gpu_mem_total = gpu.memory.total
gpu_mem_total.label = total
gpu_mem_total.formula = gpu.memory.used + gpu.memory.free
gpu_mem_total.unit = MB
gpu_mem_total.width = 8

gpu_mem_pct = gpu.memory.pct
gpu_mem_pct.label = mem%%
gpu_mem_pct.formula = 100 * gpu.memory.used / (gpu.memory.used + gpu.memory.free)
gpu_mem_pct.width = 5

#
# Power and battery statistics
# Laptop battery health, charge status, and power source monitoring
#
[macstat-pwr]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Power source
power.ac.connected = AC,,,,3
power.battery.charging = chrg,,,,4

# Battery status
power.battery.charge = pct%%,,,,5
power.battery.time_remaining = mins,,,,5

# Battery health
power.battery.health = hlth%%,,,,5
power.battery.cycle_count = cycles,,,,6

# Battery details
power.battery.temperature = temp,,dC,,5
power.battery.voltage = volt,,mV,,6
power.battery.amperage = amps,,mA,,6

# Capacity info
power.battery.capacity.design = design,,mAh,,7
power.battery.capacity.max = max,,mAh,,7

# Derived: power draw in watts (voltage * amperage / 1000000)
bat_watts = power.battery.watts
bat_watts.label = watts
bat_watts.formula = (power.battery.voltage * power.battery.amperage) / 1000000
bat_watts.width = 6

#
# Thermal monitoring statistics
# CPU/GPU temperatures, fan status, and thermal pressure for throttling diagnosis
#
[macstat-thermal]
header = yes
unitinfo = no
globals = no
timestamp = no
precision = 0
delimiter = " "
repeat_header = auto

# Temperature sensors (Celsius)
thermal.cpu.die = cpu,,dC,,5
thermal.cpu.proximity = prox,,dC,,5
thermal.gpu.die = gpu,,dC,,5
thermal.package = pkg,,dC,,5
thermal.ambient = amb,,dC,,5

# Thermal pressure (0=nominal, 1=fair, 2=serious, 3=critical)
thermal.pressure.level = press,,,,5

# Fan inventory and status
hinv.nfan = nfan,,,,4
thermal.fan.speed = rpm,,,,6
thermal.fan.target = tgt,,,,5
